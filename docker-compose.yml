services:
  # Keycloak Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: agent-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8080
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_PROXY: edge
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_FROM: noreply@ursly.io
      SMTP_REPLY_TO: support@ursly.io
      SMTP_SSL: false
      SMTP_STARTTLS: false
      SMTP_AUTH: false
    command: start-dev --import-realm --spi-theme-static-max-age=-1 --spi-theme-cache-themes=false --spi-theme-cache-templates=false
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/realms:/opt/keycloak/data/import
      - ./keycloak/themes/ursly:/opt/keycloak/themes/ursly
    depends_on:
      keycloak-db:
        condition: service_healthy
      mailhog:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - agent-network

  # PostgreSQL for Keycloak
  keycloak-db:
    image: postgres:16-alpine
    container_name: agent-keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - agent-network

  # MongoDB for audit logs
  mongodb:
    image: mongo:7
    container_name: agent-mongodb
    command: ["mongod", "--noauth", "--bind_ip_all"]
    environment:
      MONGO_INITDB_DATABASE: agent-orchestrator
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
      - ./local-dev/mongo-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - agent-network

  # Mailhog for local email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: agent-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - agent-network

  # Ollama AI Engine
  ollama:
    image: ollama/ollama:latest
    container_name: agent-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - agent-network
    # Uncomment for GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # gRPC Ollama Service
  grpc:
    build:
      context: .
      dockerfile: apps/grpc/Dockerfile
    container_name: agent-grpc
    environment:
      - NODE_ENV=production
      - OLLAMA_URL=http://ollama:11434
      - MONGODB_URI=mongodb://mongodb:27017/ursly
      - GRPC_PORT=50051
    ports:
      - "50051:50051"
    depends_on:
      ollama:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const net = require('net'); const s = net.createConnection(50051, 'localhost', () => { s.end(); process.exit(0); }); s.on('error', () => process.exit(1));\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - agent-network
    restart: unless-stopped

  # NestJS API Service
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: agent-api
    environment:
      - NODE_ENV=production
      - PORT=3000
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=agent-orchestrator
      - KEYCLOAK_CLIENT_ID=agent-api
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-change-me}
      - MONGODB_URI=mongodb://mongodb:27017/ursly
      - GRPC_SERVICE_URL=grpc:50051
      - AGENT_TOKEN_SECRET=${AGENT_TOKEN_SECRET:-your-secret-key-change-in-production}
      - AGENT_TOKEN_EXPIRY=300
      - OLLAMA_URL=http://ollama:11434
      - CORS_ORIGIN=http://localhost:4200,http://localhost:1420,http://localhost:3000,tauri://localhost,http://tauri.localhost
    ports:
      - "3000:3000"
    depends_on:
      keycloak:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      grpc:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - agent-network
    restart: unless-stopped

  # React Frontend
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: agent-web
    environment:
      - VITE_API_URL=http://localhost:3000
      - VITE_WS_URL=ws://localhost:3000
      - VITE_KEYCLOAK_URL=http://localhost:8080
      - VITE_KEYCLOAK_REALM=agent-orchestrator
      - VITE_KEYCLOAK_CLIENT_ID=agent-web
    ports:
      - "4200:80"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - agent-network
    restart: unless-stopped

volumes:
  keycloak-db-data:
    driver: local
  mongodb-data:
    driver: local
  ollama-data:
    driver: local

networks:
  agent-network:
    driver: bridge

