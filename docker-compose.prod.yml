# Production Docker Compose for app.ursly.io
# Optimized for running on a single EC2 instance
# 
# Required Environment Variables (.env file):
#   KEYCLOAK_ADMIN_PASSWORD - Admin password for Keycloak
#   KEYCLOAK_DB_PASSWORD - PostgreSQL password for Keycloak
#   KEYCLOAK_CLIENT_SECRET - Client secret for API authentication
#   MONGO_ROOT_USER - MongoDB root username
#   MONGO_ROOT_PASSWORD - MongoDB root password
#   AGENT_TOKEN_SECRET - Secret for agent token signing (min 32 chars)
#   NOVU_API_KEY - Novu notification API key
#   VITE_NOVU_APPLICATION_IDENTIFIER - Novu application ID

services:
  # Nginx reverse proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: ursly-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - web
      - api
      - keycloak
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M

  # Keycloak Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: ursly-keycloak
    environment:
      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?KEYCLOAK_ADMIN_PASSWORD is required}
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:?KEYCLOAK_DB_PASSWORD is required}
      # Hostname configuration for production
      KC_HOSTNAME: auth.ursly.io
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "true"
      KC_HTTP_ENABLED: "true"
      KC_HTTP_RELATIVE_PATH: /auth
      KC_HEALTH_ENABLED: "true"
      KC_PROXY: edge
      # SMTP configuration (optional)
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_FROM: ${SMTP_FROM:-noreply@ursly.io}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_SSL: ${SMTP_SSL:-false}
      SMTP_STARTTLS: ${SMTP_STARTTLS:-true}
    command: start --import-realm
    expose:
      - "8080"
    volumes:
      - ./keycloak/realms:/opt/keycloak/data/import:ro
      - ./keycloak/themes/ursly:/opt/keycloak/themes/ursly:ro
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 120s
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 768M

  # PostgreSQL for Keycloak
  keycloak-db:
    image: postgres:16-alpine
    container_name: ursly-keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:?KEYCLOAK_DB_PASSWORD is required}
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M

  # MongoDB for application data (agents, tasks, audit logs, entitlements)
  mongodb:
    image: mongo:7
    container_name: ursly-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:?MONGO_ROOT_USER is required}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:?MONGO_ROOT_PASSWORD is required}
      MONGO_INITDB_DATABASE: ursly
    volumes:
      - mongodb-data:/data/db
      - ./local-dev/mongo-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # Ollama AI Engine
  ollama:
    image: ollama/ollama:latest
    container_name: ursly-ollama
    volumes:
      - ollama-data:/root/.ollama
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1024M

  # gRPC Ollama Service
  grpc:
    build:
      context: .
      dockerfile: apps/grpc/Dockerfile
    container_name: ursly-grpc
    environment:
      NODE_ENV: production
      OLLAMA_URL: http://ollama:11434
      MONGODB_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/ursly?authSource=admin
      GRPC_PORT: "50051"
    expose:
      - "50051"
    depends_on:
      ollama:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('net').connect(50051, 'localhost').on('connect', () => process.exit(0)).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  # NestJS API Service
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: ursly-api
    environment:
      # Node environment
      NODE_ENV: production
      PORT: "3000"
      # Keycloak/Auth configuration
      KEYCLOAK_URL: http://keycloak:8080/auth
      KEYCLOAK_REALM: agent-orchestrator
      KEYCLOAK_CLIENT_ID: agent-api
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:?KEYCLOAK_CLIENT_SECRET is required}
      # MongoDB configuration
      MONGODB_URI: mongodb://${MONGO_ROOT_USER}:${MONGO_ROOT_PASSWORD}@mongodb:27017/ursly?authSource=admin
      # gRPC configuration
      GRPC_SERVICE_URL: grpc:50051
      # Agent token configuration
      AGENT_TOKEN_SECRET: ${AGENT_TOKEN_SECRET:?AGENT_TOKEN_SECRET is required (min 32 chars)}
      AGENT_TOKEN_EXPIRY: "300"
      # Ollama configuration
      OLLAMA_URL: http://ollama:11434
      # CORS configuration (includes Tauri desktop app origins)
      CORS_ORIGIN: https://app.ursly.io,https://api.ursly.io,http://localhost:4200,http://localhost:1420,http://localhost:3000,tauri://localhost,http://tauri.localhost
      # Novu notifications
      NOVU_API_KEY: ${NOVU_API_KEY:-}
    expose:
      - "3000"
    depends_on:
      keycloak:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      grpc:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # React Frontend
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_API_URL: https://api.ursly.io
        VITE_WS_URL: wss://api.ursly.io
        VITE_KEYCLOAK_URL: https://auth.ursly.io
        VITE_KEYCLOAK_REALM: agent-orchestrator
        VITE_KEYCLOAK_CLIENT_ID: agent-web
        VITE_NOVU_APPLICATION_IDENTIFIER: ${VITE_NOVU_APPLICATION_IDENTIFIER:-}
        VITE_GRPC_URL: https://grpc.ursly.io
    container_name: ursly-web
    expose:
      - "80"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - ursly-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M

volumes:
  keycloak-db-data:
    driver: local
  mongodb-data:
    driver: local
  ollama-data:
    driver: local

networks:
  ursly-network:
    driver: bridge


